import org.apache.tools.ant.taskdefs.condition.Os
import java.nio.file.Files;
import java.nio.file.Path;

plugins {
    id "java"
}

version = '1.0'

def static checkPath(String p) {
    if (!Files.exists(Path.of(p))) {
        throw new IllegalArgumentException("Error: the path ${p} does not exist");
    }
}

def llvm_home = project.property("llvm_home")
checkPath(llvm_home)
checkPath("${llvm_home}/lib/clang")
def clang_versions = new File("${llvm_home}/lib/clang/").list();
if (clang_versions.length == 0) {
    throw new IllegalArgumentException("Could not detect clang version." +
            " Make sure a ${llvm_home}/lib/clang/<VERSION> directory exists")
}
def clang_version = clang_versions[0]

def jextract_app_dir = "$buildDir/jextract"
def clang_include_dir = "${llvm_home}/lib/clang/${clang_version}/include"
checkPath(clang_include_dir)
def os_lib_dir = Os.isFamily(Os.FAMILY_WINDOWS)? "bin" : "lib"
def os_script_extension = Os.isFamily(Os.FAMILY_WINDOWS)? ".bat" : ""
def libclang_dir = "${llvm_home}/${os_lib_dir}"
checkPath(libclang_dir)

repositories {
    mavenCentral()
}

compileJava {
    options.compilerArgs.addAll(['--release', '18'])
    options.compilerArgs << "--add-modules=jdk.incubator.foreign"
    options.compilerArgs << "-Xlint:all"
    options.fork = true
    options.forkOptions.executable = "${jdk18_home}/bin/javac"
}

jar {
    archiveBaseName = 'org.openjdk.jextract'
    archiveVersion = project.version
}

task createJextractImage(type: Exec) {
    dependsOn jar

    onlyIf { !new File("$buildDir/jextract-jdk-image").exists() }

    executable = "${jdk18_home}/bin/jlink"
    args = [
         "--module-path=$buildDir/libs",
         "--add-modules=org.openjdk.jextract,jdk.compiler",
         "--output=${jextract_app_dir}",
         "--launcher=jextract=org.openjdk.jextract/org.openjdk.jextract.JextractTool",
         "--add-options",
         '"--enable-native-access=org.openjdk.jextract"'
    ]
}

task copyLibClang(type: Copy) {
    dependsOn createJextractImage

    into("$buildDir")

    from("${libclang_dir}") {
        include("*clang.*")
        include("libLLVM.*")
        into("jextract/${os_lib_dir}")
    }

    from("$clang_include_dir") {
        include("*.h")
        into("jextract/conf/jextract")
    }
}

// jextract jdk image
task jextractapp() {
    dependsOn copyLibClang
}

// very simple integration test for generated jextract
task verify(type: Exec) {
    dependsOn jextractapp

    executable = "${jextract_app_dir}/bin/jextract${os_script_extension}"
    args = [ "test.h", "-d", "$buildDir/integration_test" ]
}

// jlink a JDK image with org.openjdk.jextract for testing
task createRuntimeImageForTest(type: Exec) {
    dependsOn verify

    onlyIf { !new File("$buildDir/jextract-jdk-test-image").exists() }
    executable = "${jdk18_home}/bin/jlink"
    args = [
         "--module-path=$buildDir/libs" + File.pathSeparator + "$jdk18_home/jmods",
         "--add-modules=ALL-MODULE-PATH",
         "--output=$buildDir/jextract-jdk-test-image",
    ]
}

task prepareTestJDK(type: Copy) {
    dependsOn createRuntimeImageForTest

    into("$buildDir")

    from("${libclang_dir}") {
        include("*clang.*")
        include("libLLVM.*")
        into("jextract-jdk-test-image/${os_lib_dir}")
    }

    from("$clang_include_dir") {
        include("*.h")
        into("jextract-jdk-test-image/conf/jextract")
    }
}

task cmakeConfigure(type: Exec) {
    executable = "cmake"
    args = [
        "-B", "$buildDir/testlib-build",
        "-S", "$projectDir/test/test-support",
        "-DTEST_SOURCE_ROOT:FILEPATH=$projectDir/test",
        "-DCMAKE_BUILD_TYPE:STRING=Release",
        "-DCMAKE_INSTALL_PREFIX:FILEPATH=$buildDir/testlib-install"
    ]
}

task cmakeBuild(type: Exec) {
    dependsOn cmakeConfigure

    executable = "cmake"
    args = [
        "--build", "$buildDir/testlib-build",
        "--config", "Release",
        "--target", "install"
    ]
}

// run jtreg tests. Note: needs jtreg_cmd variable set to point to the jtreg
task jtreg(type: JavaExec) {
    dependsOn prepareTestJDK,cmakeBuild

    doFirst {
        if (findProperty("jtreg_home") == null) {
            throw new GradleException("jtreg_home is not defined")
        }
    }

    workingDir = "$buildDir"

    classpath = files(findProperty("jtreg_home") + "/lib/jtreg.jar")

    args = [
            "-jdk", "$buildDir/jextract-jdk-test-image",
            "-nativepath:$buildDir/testlib-install/${os_lib_dir}",
            "-javaoption:--enable-native-access=org.openjdk.jextract,ALL-UNNAMED",
            "-avm", "-conc:auto", "-verbose:summary",
            "../test"
    ]
}
